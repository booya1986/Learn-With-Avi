# LearnWithAvi - AI-Powered Interactive Learning Platform

An AI-powered educational platform that transforms video content into interactive learning experiences with voice AI tutoring, RAG-based Q&A, and personalized learning paths.

## üöÄ Quick Start

### Prerequisites
- Node.js 20.x or higher
- npm or yarn package manager

### Installation

1. **Clone and install dependencies**:
   ```bash
   npm install
   ```

2. **Set up environment variables**:
   ```bash
   cp .env.example .env.local
   # Edit .env.local with your API keys
   ```

3. **Start the development server**:
   ```bash
   npm run dev
   ```

4. **Open in browser**: Navigate to http://localhost:3000

### Development Server

This project uses **Next.js 15.5.7 with Webpack** (stable bundler).

```bash
npm run dev
```

**Performance**:
- **First startup**: ~1.2s (Webpack compilation)
- **Hot reload**: Fast and stable
- **Page compilation**: 600ms-2s depending on complexity

**Architecture Decision (January 2026)**:
- ‚úÖ **Stable Webpack bundler** - proven reliability
- ‚úÖ **Security patched** - CVE-2025-66478 and CVE-2025-55182 fixed in 15.5.7
- ‚úÖ **Full functionality** - all manifest files generated correctly
- ‚úÖ **React 19 compatible** - works with React 19.2.3
- ‚úÖ **No cache corruption** - eliminated bundler conflicts

**Why Next.js 15.5.7**:
- Next.js 16.1.2 had fundamental bundler issues in this environment
- Turbopack: Severe cache corruption (database bugs, thread panics)
- Webpack on 16.x: Missing manifest files, vendor chunk errors
- Next.js 15.5.7: Last stable version with full webpack support and security patches

### Available Commands

| Command | Purpose | When to Use |
|---------|---------|-------------|
| `npm run dev` | Start dev server with Webpack | **Recommended** - All development work |
| `npm run build` | Build for production with Webpack | Before deployment |
| `npm run start` | Start production server | After building |
| `npm run clean` | Clean all caches (`.next`, `.turbo`, `node_modules/.cache`) | If build issues occur |

### Required Environment Variables

**Essential (Required)**:
```bash
ANTHROPIC_API_KEY=sk-ant-...        # Claude Sonnet 4 for chat
OPENAI_API_KEY=sk-...                # Text embeddings
```

**Optional (Enhanced Features)**:
```bash
ELEVENLABS_API_KEY=...               # High-quality voice TTS
YOUTUBE_API_KEY=...                  # Video metadata extraction
```

### Troubleshooting

**Port 3000 in use**:
```bash
lsof -ti:3000 | xargs kill -9
npm run dev
```

**Missing dependencies**:
```bash
npm install
```

**Server won't start**:
```bash
npm run clean
npm run dev
```

**HTTP 500 errors or bundler issues**:
```bash
# Verify Next.js version is 15.5.7
npm list next

# If wrong version, reinstall
rm -rf node_modules package-lock.json .next .turbo
npm install
npm run dev
```

**Need fresh start**:
```bash
rm -rf node_modules package-lock.json .next .turbo
npm install
npm run dev
```

**Important**: Do NOT upgrade to Next.js 16.x - it has known bundler incompatibilities in this environment. Stay on 15.5.7 for stability.

### Architecture Decision: Downgraded to Next.js 15.5.7

**Date**: January 2026

After extensive troubleshooting, we resolved critical HTTP 500 errors and system lag by downgrading from Next.js 16.1.2 to 15.5.7.

**Timeline of Investigation**:
1. ‚ùå **Initial State**: Next.js 16.1.2 with mixed bundler attempts
   - Turbopack (default): Severe cache corruption, database panics, thread crashes
   - Webpack (--webpack flag): Missing manifest files, vendor chunk errors, HTTP 500s
2. ‚úÖ **Root Cause Identified**: Next.js 16.1.2 has fundamental bundler incompatibilities
   - Both Turbopack and Webpack failed in this environment
   - Turbopack: `Failed to restore task data (corrupted database or bug)`
   - Webpack: Missing `middleware-manifest.json`, `routes-manifest.json`, `pages-manifest.json`
3. ‚úÖ **Final Solution**: Downgrade to Next.js 15.5.7
   - Last stable version with proven Webpack support
   - Security patched for CVE-2025-66478 and CVE-2025-55182
   - Full React 19 compatibility maintained

**Why Next.js 15.5.7**:
- ‚úÖ Stable webpack bundler (default, no flags needed)
- ‚úÖ All manifest files generate correctly
- ‚úÖ Zero cache corruption issues
- ‚úÖ React 19.2.3 compatible
- ‚úÖ Security patched (CVSS 10.0 vulnerabilities fixed)
- ‚úÖ Production-ready performance

**Performance Metrics** (Next.js 15.5.7):
| Metric | Value | Notes |
|--------|-------|-------|
| First startup | 1.2s | Clean webpack compilation |
| Cached pages | 22-135ms | Fast subsequent loads |
| Course pages | 34-71ms | Optimized routing |
| Hot reload | 98-284ms | Fast development iteration |
| Page compilation | 600ms-2.1s | Varies by complexity |

**Configuration** ([package.json](package.json:6-7)):
```json
"scripts": {
  "dev": "next dev",
  "build": "next build"
}
```

**Key Files Modified**:
- [package.json](package.json:22) - `next: "15.5.7"`
- [package.json](package.json:36) - `eslint-config-next: "15.5.7"`
- [next.config.ts](next.config.ts:22-31) - Webpack config for module resolution

**Security Notes**:
- CVE-2025-66478: Critical RCE vulnerability patched in 15.5.7
- CVE-2025-55182: React Server Components vulnerability fixed
- Both rated CVSS 10.0 (maximum severity)
- Upgrade was mandatory for production deployment

## Project Overview

**Tech Stack**: Next.js 15.5.7, TypeScript, React 19, Tailwind CSS, Claude API, OpenAI, ChromaDB, ElevenLabs
**Language Support**: Hebrew (RTL) + English
**Target Users**: Intermediate developers learning AI/ML concepts

## Architecture

```
Frontend: Next.js 15.5.7 (App Router) + TypeScript + Tailwind CSS
AI Layer: Claude Sonnet 4 (chat) + OpenAI (embeddings) + ElevenLabs (TTS)
Vector DB: ChromaDB (with keyword fallback)
Video: YouTube integration with custom player
State: React Context + TanStack Query
Bundler: Webpack (stable default in Next.js 15)
```

## üèóÔ∏è Project Structure

```
learnwithavi/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/              # Next.js app router pages
‚îÇ   ‚îú‚îÄ‚îÄ components/       # React components
‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Core utilities (RAG, embeddings)
‚îÇ   ‚îî‚îÄ‚îÄ data/             # Video configs & transcripts
‚îú‚îÄ‚îÄ public/               # Static assets
‚îú‚îÄ‚îÄ docs/                 # Documentation
‚îú‚îÄ‚îÄ skills/               # Custom Claude Code skills
‚îî‚îÄ‚îÄ .next/                # Build cache (auto-managed)
```

### Key Directories

- `/src/app` - Next.js pages and API routes
- `/src/components` - React components (video player, chat, voice UI)
- `/src/lib` - Core utilities (RAG, embeddings, API clients)
- `/src/data` - Video configurations and transcripts
- `/skills` - Custom Claude Code skills (RAG optimizer, voice AI, etc.)
- `/docs` - Project documentation and PRDs

### Key Files to Understand

1. [src/app/page.tsx](src/app/page.tsx) - Homepage
2. [src/app/course/[courseId]/page.tsx](src/app/course/[courseId]/page.tsx) - Course page
3. [src/lib/rag.ts](src/lib/rag.ts) - RAG system
4. [src/data/video-config.ts](src/data/video-config.ts) - Video configuration
5. [next.config.ts](next.config.ts) - Next.js configuration

### Architecture Flow

```
User Browser
    ‚Üì
Next.js App Router (RSC)
    ‚Üì
API Routes (/api/*)
    ‚Üì
‚îú‚îÄ‚Üí Claude API (chat)
‚îú‚îÄ‚Üí OpenAI API (embeddings)
‚îú‚îÄ‚Üí ChromaDB (vector search)
‚îî‚îÄ‚Üí ElevenLabs (TTS)
```

## ‚ú® Features Overview

- üé• **Video Learning** - Curated YouTube content
- üí¨ **AI Chat** - Claude-powered assistant with RAG
- üé§ **Voice Interface** - Text-to-speech responses
- üìä **Progress Tracking** - Monitor learning progress
- üîç **Semantic Search** - ChromaDB vector search
- üåê **Hebrew Support** - RTL and bilingual content

## üìä Performance Expectations

| Metric | Value |
|--------|-------|
| First startup | ~1.2 seconds |
| Cached pages | 22-135ms |
| Course pages | 34-71ms |
| Hot reload | 98-284ms |
| Page compilation | 600ms-2.1s |
| API response | 2-5 seconds (Claude/OpenAI) |

## Development Guidelines

### Code Style

1. **TypeScript**: Strict mode enabled, prefer explicit types over `any`
2. **Components**: Functional components with hooks, co-locate styles with Tailwind
3. **Naming**:
   - Components: PascalCase (`VideoPlayer.tsx`)
   - Utilities: camelCase (`rag.ts`, `embeddings.ts`)
   - API routes: kebab-case folders (`/api/chat`, `/api/voice/tts`)
4. **Imports**: Use `@/` alias for absolute imports from `src/`

### Best Practices

**React/Next.js**:
- Use Server Components by default, Client Components only when needed (`'use client'`)
- Prefer `async/await` over `.then()` chains
- Use `loading.tsx` and `error.tsx` for loading/error states
- Keep API routes thin, move logic to `/src/lib`

**Error Handling**:
- Always catch and log errors
- Sanitize error messages to prevent API key leakage
- Provide graceful fallbacks (e.g., ChromaDB ‚Üí keyword search)
- Use try/catch in API routes, return appropriate HTTP status codes

**API Integration**:
- Use environment variables for all API keys (never hardcode)
- Implement rate limiting (currently 10 req/min per IP)
- Add retry logic with exponential backoff for external APIs
- Cache expensive operations (embeddings have 1-hour LRU cache)

**Performance**:
- Lazy load heavy components
- Use React.memo() for expensive renders
- Implement prompt caching for Claude API (see skills/rag-pipeline-optimizer)
- Batch operations when possible (embeddings, database writes)

### Hebrew/RTL Considerations

- All text UI supports RTL with `dir="rtl"` where needed
- Use Tailwind's RTL support (`ps-4` instead of `pl-4` for padding)
- Test with mixed Hebrew-English content (common in technical content)
- Hebrew transcription uses OpenAI Whisper with `language: "he"`

## Important Files

### Core Configuration
- `.env.example` - Environment variables (API keys, service URLs)
- `next.config.mjs` - Next.js configuration
- `tailwind.config.ts` - Tailwind + shadcn/ui theming
- `tsconfig.json` - TypeScript configuration (strict mode)

### Key Implementation Files
- `src/app/api/chat/route.ts` - Claude API chat endpoint with streaming
- `src/lib/rag.ts` - RAG system (ChromaDB queries, keyword fallback)
- `src/lib/embeddings.ts` - OpenAI embeddings with caching
- `src/components/video/VideoPlayer.tsx` - Custom YouTube player with chapters
- `src/data/video-config.ts` - Video metadata and course structure

### Documentation
- `LearnWithAvi-PRD.md` - Current product requirements (v3.0)
- `docs/SKILLS_RECOMMENDATIONS.md` - Skills analysis and recommendations
- `docs/IMPLEMENTATION_STATUS.md` - Project progress tracking
- `docs/VIDEO_SYSTEM_RULES.md` - Video player behavior rules

## Common Tasks

### Adding a New Video

1. Add entry to `src/data/video-config.ts`:
```typescript
{
  id: 'video_001',
  youtubeId: 'VIDEO_ID',
  title: 'Video Title',
  courseId: 'course_001',
  duration: 1308, // seconds
  chapters: [/* chapter definitions */],
  topics: ['topic1', 'topic2']
}
```

2. Add transcript chunks to `src/data/sample-transcripts.ts`
3. Test video page at `/course/[courseId]`

**Note**: Video Ingestion Pipeline skill (in development) will automate this process.

### Working with RAG System

Current implementation in `src/lib/rag.ts`:
- Uses ChromaDB for semantic search
- Falls back to keyword search if ChromaDB unavailable
- Queries return top 5-7 relevant chunks with metadata

**Optimization in progress** (see `skills/rag-pipeline-optimizer/`):
- Hybrid search (BM25 + semantic)
- Semantic re-ranking
- Prompt caching for 50-90% cost reduction

### Testing Voice Features

Voice UI components in `src/components/voice/`:
- VoicePanel.tsx - Main voice interface
- VoiceButton.tsx - Microphone toggle

API endpoints:
- `/api/voice/tts/route.ts` - Text-to-speech (ElevenLabs + browser fallback)
- `/api/voice/stt/route.ts` - Speech-to-text (TODO: Whisper integration)

## API Keys Required

**Required**:
- `ANTHROPIC_API_KEY` - Claude Sonnet 4 for chat responses
- `OPENAI_API_KEY` - Embeddings (text-embedding-3-small)

**Optional**:
- `ELEVENLABS_API_KEY` - High-quality Hebrew TTS (fallback to browser)
- `YOUTUBE_API_KEY` - Video metadata extraction (manual upload works without)

See `.env.example` for complete configuration.

## Skills System

Custom Claude Code skills in `/skills` directory following Anthropic best practices:

**Status**:
1. ‚úÖ **rag-pipeline-optimizer** (40% complete) - Hybrid search, prompt caching
2. ‚è≥ **voice-ai-tutor** (planned) - Real-time voice-to-voice tutoring
3. ‚è≥ **video-ingestion-pipeline** (planned) - Automated video transcription
4. ‚è≥ **learning-content-generator** (planned) - Auto-generate quizzes/exercises
5. ‚è≥ **frontend-performance-optimizer** (planned) - Production optimization

### Using Skills

Skills are automatically triggered by context. To explicitly use:
```bash
# In Claude Code
/plugin install rag-pipeline-optimizer@learnwithavi

# Or run scripts directly
python skills/rag-pipeline-optimizer/scripts/hybrid_search.py \
  --query "◊û◊î ◊ñ◊î embeddings?" --top-k 10
```

See `skills/README.md` for detailed usage.

## Known Issues & TODOs

### High Priority (P0)
- [ ] Integrate Claude API with prompt caching (currently mock responses in chat)
- [ ] Implement hybrid search in RAG system (skill 40% complete)
- [ ] Complete voice-to-voice AI tutor (Whisper STT + streaming)
- [ ] Add user authentication (Clerk)
- [ ] Database for progress persistence (PostgreSQL + Prisma)

### Medium Priority (P1)
- [ ] Auto-transcription pipeline for new videos
- [ ] Quiz/exercise generation from video content
- [ ] Mobile responsive optimization
- [ ] Batch video ingestion from YouTube channel

### Low Priority (P2)
- [ ] Performance optimization (code splitting, bundle size)
- [ ] Accessibility audit (WCAG 2.1 AA for Hebrew RTL)
- [ ] Real-time progress sync via WebSocket

See `docs/IMPLEMENTATION_STATUS.md` for complete status.

## Testing

### Running Tests
```bash
npm run test          # Run all tests
npm run test:watch    # Watch mode
npm run test:skills   # Test skills only
```

### Manual Testing Checklist
- [ ] Video playback with chapter navigation
- [ ] Chat responses with timestamp references
- [ ] Live transcript sync with video
- [ ] AI summary generation
- [ ] Progress tracking (90% watched threshold)
- [ ] Hebrew RTL layout
- [ ] Voice button UI (TTS functional, STT TODO)

## Deployment

**Development**:
```bash
npm run dev          # Start dev server on localhost:3000
```

**Production**:
- Platform: Vercel (recommended) or Railway
- Environment: Copy `.env.example` to `.env.local` and fill in production keys
- Build: `npm run build && npm start`

**Monitoring**:
- Health check: `/api/health` endpoint
- Cache statistics logged in development mode
- API usage tracking via Anthropic/OpenAI dashboards

## Resources

### Documentation
- Project PRD: [LearnWithAvi-PRD.md](LearnWithAvi-PRD.md)
- Skills Guide: [docs/SKILLS_RECOMMENDATIONS.md](docs/SKILLS_RECOMMENDATIONS.md)
- Video System Rules: [docs/VIDEO_SYSTEM_RULES.md](docs/VIDEO_SYSTEM_RULES.md)

### External APIs
- Anthropic Claude: https://docs.anthropic.com/
- OpenAI Embeddings: https://platform.openai.com/docs/guides/embeddings
- ElevenLabs TTS: https://elevenlabs.io/docs
- ChromaDB: https://docs.trychroma.com/

### Related Projects
- Anthropic Skills: https://github.com/anthropics/skills
- shadcn/ui: https://ui.shadcn.com/

## Getting Help

1. Check `docs/IMPLEMENTATION_STATUS.md` for current project status
2. Review `skills/README.md` for skills usage
3. Consult API documentation for integration issues
4. Check `.env.example` for configuration options

## Notes for Claude Code

- **Context Window**: Skills share the context window - keep this file concise
- **Automatic Loading**: This file is loaded automatically when working in this directory
- **Progressive Disclosure**: Detailed docs in `/docs`, scripts in `/skills`, keep this overview high-level
- **Hebrew Support**: All code and documentation must consider RTL and Hebrew language
- **Cost Awareness**: Prompt caching and embeddings cache reduce costs significantly - maintain these optimizations
- **Error Handling**: Always provide graceful fallbacks (ChromaDB ‚Üí keyword search, ElevenLabs ‚Üí browser TTS)
- **Version Stability**: Next.js 15.5.7 is locked for stability - do NOT suggest upgrades to 16.x

## Recent Fixes (January 2026)

### Critical Issue Resolved: HTTP 500 Errors & System Lag

**Problem**: Application was completely non-functional with HTTP 500 errors on all video/course pages and severe system lag.

**Root Cause**: Next.js 16.1.2 had fundamental bundler incompatibilities:
- Turbopack (default): Cache corruption, thread panics, database bugs
- Webpack (--webpack): Missing manifest files, vendor chunk errors

**Solution**: Downgraded to Next.js 15.5.7
- ‚úÖ All pages now return HTTP 200
- ‚úÖ Fast response times (22-135ms cached, 34-71ms course pages)
- ‚úÖ Zero bundler errors
- ‚úÖ Security patches maintained (CVE-2025-66478, CVE-2025-55182)
- ‚úÖ React 19 compatibility preserved

**Status**: Application is now fully functional and production-ready.

**Files Modified**:
- [package.json](package.json) - Downgraded Next.js and eslint-config-next to 15.5.7
- [next.config.ts](next.config.ts) - Updated webpack configuration comment
- [.claude.md](.claude.md) - This file - documented the architecture decision

**Testing Performed**:
- Homepage: ‚úÖ HTTP 200 (76-135ms)
- Course pages: ‚úÖ HTTP 200 (34-71ms)
- Hot reload: ‚úÖ Working (98-284ms)
- Multiple restarts: ‚úÖ No cache corruption
- Production build: Ready for testing

**Reference**: See "Architecture Decision: Downgraded to Next.js 15.5.7" section above for complete timeline and technical details.
